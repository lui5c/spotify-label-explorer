<!doctype html>
<html>
  <head>
    <title>Example of the Authorization Code flow with Spotify</title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="static/stylesheet.css">
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>
  </head>

  <body>
		<!-- the login stuff -->
      <div id="login">
		<div class="container">
		<div id="header-container" style="font-size: 36px; padding-top: 15px">
			spotify label explorer!!!!!! <div style="display: none" id="hidden-enter-button"> <a href="/login">enter >> </a></div>
		</div>
		<h3>welcome!</h3>
		<div style="font-size: 16px">
		<p>this web app allows you to explore which labels are represented on a Spotify playlist and which labels an artist has released music on. </p>
		<p>you can use it for whatever you want, but i like to use it to find music related to the things i already listen to. many recent music streaming 
		platforms have made it a central feature in their program or software to integrate "radio" or other song suggestion mechanisms. these predictive playlists/radio stations are based on models of what the user already listen to. however, collections of music that have a similar motif, shared community, or other commonality already tend to be grouped together! they can be found by looking at the discography of a label.</p>
		<h3>labels</h3>
		<p>whenever an album is released, usually there is a "record label" that is credited with "releasing" the album. it's kind of a weird setup, and many bands elect to self-release music, bypassing any bureacracy and hoop-jumping brought on by looping in other people. most of the time, bands work with labels in a symbiotic way, where bands make music, and labels take care of promotion, advertising, maybe booking shows, and maybe getting their record pressed on vinyl for cheaper than it would be without the label. usually, the bands that a label works with all have something in common that made them work with each other.</p>
		<p>there are genre-oriented labels, location-specific labels, reissue labels, labels that only ever see one release, labels that were only in operation for a year and a half, multi-million dollar massive corporation labels, labels that get created whenever someone releases their first and only solo EP through <a href="http://www.distrokid.com/">DistroKid</a>, and any combination of those already mentioned above. it's a way funner way to find music than song suggestions from a streaming service when you finish a playlist!</p>
		<h3>example of how you might find new music</h3>
		<p>say you like a synth-pop band from Paris. you want to go on a synth-pop kick, and want to listen to all of this artist's contemporaries. you can check out "what fans listen to" (which works pretty well), but you want more. you decide to check out their label. you can see all of the albums that have been released by the label that put out that synth-pop album. maybe it turns out that this label only does synth-pop! or maybe it's a Parisian label, and you find a band that is best buddies with your original band, because they're all living within a couple blocks of each other. regardless, you have seen at least a little of a community that exists because of music. labels are really important for scenes to thrive and for small bands to find each other and find people who want to hear their music. Spotify and Apple Music don't have ways for you to explore a label the way they have ways for you to explore artists and collections of playlists. </p>
		<h3>where do i start?!</h3>
		<p>in order to enter/use the label explorer, you need to log in with Spotify &rarr; <a href="/login">log in using Spotify</a> and you will be brought to the site!</p>
		<h3>privacy</h3>
		<p>your data will not be stored anywhere, will most certainly not be sold to anybody, and will not be used for any purpose or at any time other than what happens right now.</p>
		</div> <!-- the font size setter -->
		</div> <!-- the container -->
      </div>

		<!-- once you're logged in -->
      <div id="loggedin" class="w3-container">
		<div id="oauth">
        <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>        
		</div>
		<div id="top-guide">
		<h1>welcome, <span id="person-name"></span>!</h1>
		<h3>how to use the label explorer </h3>
		<p>in the left-hand pane, you can choose between browsing your playlists and searching for artists. if you click on an artist, a list of that artists's releases, along with the label that released them, will come up. if you click on a playlist, a list of the songs in the playlist will be displayed and you will be able to see what label each song on the playlist is on. in the right-hand pane, you can search Spotify for all of the releases by a particular label.</p>
		<h3>a note about Spotify's indexing of labels</h3>
		<p>currently, there is no way to view a label's discography in Spotify, nor is there a way to retrieve a label's discography using the Spotify Web API, which this site uses. this website uses the closest approximation possible (without indexing Spotify's entire database) which is to type the following into the search bar: <code>label="sun records"</code>, replacing sun records with whatever record label's results you want to see. try it here, or try it in Spotify!</p>
		</div>
		<!-- begin stuff to show when logged in that is NOT user profile -->
		<div class="overall-container">
			<div class="leftside-container">
			
			<ul class="nav nav-pills nav-fill nav-justified">
				<li id="show-playlist-search"> <a class="nav-item">look up a playlist</a> </li>
				<li id="show-artist-search"> <a class="nav-item">look up an artist</a> </li>
			</ul>		
			<div id="playlists-container">
				<table class="playlist-table" id="playlist-list-table">
					<thead>
						<tr>
							<th> playlist </th>
							<th> length </th>
							<th> playlistID </th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div id="button-container">
			<button id="button-populate">&#43;</button>
			</div>
			</div>
			
			<div id="artists-container">
			<input id="artist-search-box" type="text" class="form-control" placeholder="search" name="search" />
			<button class="btn btn-outline-success my-2 my-sm-0" id="artist-search-button">go!</button>
			<table class="playlist-table" id="artist-search-results">
			</table>
			</div> <!-- end artist search container -->
			</div> <!-- end left half container -->
			<div id="rightside-container"> <!-- begin the search BY LABEL function -->
			</div><!-- end right side container -->
		</div> <!-- end overall-container -->
		
		<!-- begin playlist overlay code -->
		<div id="playlist-overlay">
			<div id="overlaytitle">
				<span id="selected-playlist-name">Playlist Name</span>
				<span> by </span>
				<span id="selected-playlist-owner">Playlist Owner</span>
				<span id="close-playlist-overlay">close</span>
			</div>
			<div id="table-container">
				<table id="songs-table" class="overlay-table">
					<thead>
					<tr>
						<th> song </th>
						<th> artist </th>
						<th> album </th>
						<th> label </th>
					</tr>
					</thead>
				</table>
			</div> <!-- end table-container -->
		</div> <!-- end playlist overlay -->
		<div id="releases-overlay">
			<div id="overlaytitle">
				releases by 
				<span id="selected-artist">artist</span>
				<span id="close-artist-overlay">close</span>
			</div>
			<div id="table-container">
				<table id="releases-table" class="overlay-table">
					<thead>
					<tr>
						<th> release name </th>
						<th> date </th>
						<th> label </th>
					</tr>
					</thead>
				</table>
			</div> <!-- end table-container -->
		</div> <!-- end playlist overlay -->
	</div> <!-- end #loggedin container -->
	
	<!-- beyond this, it's all <script> tags and then </body -->
	
	<!-- im not gonna use the handlebars thing and just modify <span> things i think
	
    <script id="user-profile-template" type="text/x-handlebars-template">
	<div id="assembly-container"> 
	<h1> welcome, {{display_name}}! </h1>
	
	</div>
    </script> -->
	
	
	
	<!-- the stuff for getting new tokens. probably will come later -->
    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

	<!-- this i figured was nice for just vanilla javascript components -->
	<script type="text/javascript">
	
	
	
	</script>
	
	
    <script>
      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        //var userProfileSource = document.getElementById('user-profile-template').innerHTML,
        //    userProfileTemplate = Handlebars.compile(userProfileSource),
        //    userProfilePlaceholder = document.getElementById('user-profile');

        //var oauthSource = document.getElementById('oauth-template').innerHTML,
        //    oauthTemplate = Handlebars.compile(oauthSource),
        //    oauthPlaceholder = document.getElementById('oauth');

        var params = getHashParams();


        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

/** Here begins Luis's code **/
	//todo: get a function that adds rows without context
	//todo: fix table header in overlay box

	var closePlaylistOverlay = document.getElementById('close-playlist-overlay');
	var closeArtistOverlay = document.getElementById('close-artist-overlay');
	var dialogPlaylist = document.getElementById('songs-table');
	
	closePlaylistOverlay.onclick = hideOverlay;
	closeArtistOverlay.onclick = hideOverlay;
	
	function hideOverlay(){
		var goner_rows = document.getElementsByClassName('temp-row');
		//console.log(goner_rows);
		while(goner_rows[0]){
			goner_rows[0].parentNode.removeChild(goner_rows[0]);
		}
		$('#playlist-overlay').css('display', 'none');
		$('#releases-overlay').css('display', 'none');
	}
	
	//this is the code for populating the table with playlists
	var myTable = document.getElementById('playlist-list-table');
	const button = document.getElementById('button-populate');
	
	button.onclick = requestTwentyRows;
	var offset = 0; //offset for which playlist to GET from spotify API
	
	function addRow(name, length, playlistID){
		var theEnd = myTable.rows.length;
		var newRow = myTable.insertRow(theEnd);
		var cell1 = newRow.insertCell(0);
		cell1.innerHTML = name;
		var cell2 = newRow.insertCell(1);
		cell2.innerHTML = length;
		var cell3 = newRow.insertCell(2);	
		cell3.innerHTML = playlistID;
		newRow.onclick = bringUpPlaylistDialog;
	}
	
	function requestTwentyRows(){
		$.ajax({
			url: 'https://api.spotify.com/v1/me/playlists',
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			data: {
				limit: '20',
			 	offset: offset
			},
			success: function(response){
					//the response is preformatted JSON!
					//console.log(response);
					var i;
					for (i = 0; i < response.items.length; i++){
						var playlist = response.items[i];
						addRow(playlist.name, playlist.tracks.total, playlist.id);
					}					
				}
			});
		offset += 20;
	}
	
	//and here is the code for handling the expansion of a playlist on click
	
	function addSong(name, artist, album, label){
		var theEnd = dialogPlaylist.rows.length;
		var newRow = dialogPlaylist.insertRow(theEnd);
		newRow.classList.add("temp-row");
		var cell1 = newRow.insertCell(0);
		cell1.innerHTML = name;
		var cell2 = newRow.insertCell(1);
		cell2.innerHTML = artist;
		var cell3 = newRow.insertCell(2);
		cell3.innerHTML = album;
		var cell4 = newRow.insertCell(3);
		cell4.innerHTML = label;
	}
	
	function parseSong(song){
		var name = song.track.name;
		
		var artistObjectArray = song.track.artists;
		var artistObject = artistObjectArray[0];
		var artist = artistObject.name;
		var artist_index = 1;
		while (artist_index < artistObjectArray.length){
			artistObject = artistObjectArray[artist_index];
			var toAdd = ", " + artistObject.name;
			artist += toAdd;
			artist_index++;
		}
		
		while (artist_index < song.track.artists.length){
			var artistToAdd = 
			artist += "," + song.track.artists[artist_index];
			artist_index++;
		}
		var album = song.track.album.name;
		var href = song.track.album.href;
		var label;
		
		$.ajax({
			url: href,
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			success: function(fullAlbumObject){
					//the response is preformatted JSON!
					label = fullAlbumObject.label;
					addSong(name, artist, album, label);
				}
		});
	}
	
	function bringUpPlaylistDialog(){
		//get id of the clicked playlist
		var playlistID = $(this).children().eq(2).text();
		var url = 'https://api.spotify.com/v1/playlists/' + playlistID;
		
		$.ajax({
			url: url,
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			success: function(playlistObject){
					//the response is preformatted JSON!
					var pagingObject = playlistObject.tracks;
					var arrayOfTracks = pagingObject.items;
					var sizeOfPlaylist = pagingObject.total;
					//console.log(arrayOfTracks);
					var i;
					for (i = 0; i < sizeOfPlaylist; i++){
						parseSong(arrayOfTracks[i]);
					}					
					$("#selected-playlist-name").text(playlistObject.name);
					$("#selected-playlist-owner").text(playlistObject.owner.display_name);
				}
		});
		$("#playlist-overlay").css('display', 'block');
	}

	
	/** cute code for getting the navbar to get smaller or bigger with scroll 
	window.onscroll = function() {scrollFunction()};
	const profPic = document.getElementById('profile-pic');
	const header = document.getElementById('user-profile');
	
	function scrollFunction(){
		var amtScrolled = document.documentElement.scrollTop;
		//console.log(amtScrolled);
		if (amtScrolled > 100){
			document.getElementById('profile-pic').style.maxHeight = "70px";
			document.getElementById('user-profile').style.fontSize = "35px";
		} else{
			var newPicHeight = 70 + 90*(1 - amtScrolled/100);
			var newFontSize = 35 + 35*(1 - amtScrolled/100);
			document.getElementById('profile-pic').style.maxHeight = newPicHeight + "px";
			document.getElementById('user-profile').style.fontSize = newFontSize + "px";
		}
	} **/
	
	/** code for tabbing through playlist search or artist search **/
	
	const playlistSearchView = document.getElementById("show-playlist-search");
	const artistSearchView = document.getElementById("show-artist-search");

	const playlistsContainer = document.getElementById("playlists-container");
	const artistsContainer = document.getElementById("artists-container");
	
	playlistSearchView.onclick = showPlaylistSearch;
	artistSearchView.onclick = showArtistSearch;
	
	function showPlaylistSearch(){
		artistsContainer.style.width = "0%";
		artistsContainer.style.display = "none";
		playlistsContainer.style.width = "100%";
		playlistSearchView.style.backgroundColor = "#e0e0e0";
		artistSearchView.style.backgroundColor = "white";
	}
	
	function showArtistSearch(){
		artistsContainer.style.display = "block";
		artistsContainer.style.width = "100%";
		playlistsContainer.style.width = "0%";
		playlistSearchView.style.backgroundColor = "white";
		artistSearchView.style.backgroundColor = "#e0e0e0";
	}

	/** handling artist search form submission **/
	const artistSearchBox = document.getElementById("artist-search-box");
	const artistSearchButton = document.getElementById("artist-search-button");
	artistSearchButton.onclick = conductArtistSearch;
	
	
	function conductArtistSearch(){
		var rawQuery = artistSearchBox.value;
		var arrayOfArtistObjects;
		clearSearchResults();
		
		$.ajax({
			url: 'https://api.spotify.com/v1/search',
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			data: {
				q: rawQuery,
				type: 'artist',
			},
			success: function(response){
					//the response is preformatted JSON!
					//console.log(response);
					arrayOfArtistObjects = response;
					var i;
					for (i = 0; i < arrayOfArtistObjects.artists.items.length; i++){
						var currentArtistObject = arrayOfArtistObjects.artists.items[i];
						addNewSearchResult(currentArtistObject.name, currentArtistObject.id);
					}
				}
			});
		}
		
	/** code for showing search results **/
	var resultsList = document.getElementById("artist-search-results");
	
	function clearSearchResults(){
		while (resultsList.firstChild){
			resultsList.removeChild(resultsList.firstChild);
		}
	}
	
	function addNewSearchResult(artistName, artistID){
		var theEnd = resultsList.rows.length;
		var newRow = resultsList.insertRow(theEnd);
		var cell1 = newRow.insertCell(0);
		cell1.innerHTML = artistName;
		var cell2 = newRow.insertCell(1);
		cell2.innerHTML = artistID;
		newRow.onclick = showArtistDialog;
	}
	
	var artistReleasesDialog = document.getElementById("releases-overlay");
	
	function showArtistDialog(){
		var artistID = $(this).children().eq(1).text();
		var artistName = $(this).children().eq(0).text();
		var url = 'https://api.spotify.com/v1/artists/' + artistID + '/albums';
		$.ajax({
			url: url,
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			success: function(response){
					//the response is preformatted JSON!
					//response.items is an array of release objects
					var i;
					for (i = 0; i < response.items.length; i++){
						parseRelease(response.items[i]);
					}
				}
		});
		$("#releases-overlay").css('display', 'block');
		$("#selected-artist").text(artistName);
	}
	
	function parseRelease(releaseObject){
		var url = releaseObject.href;
		$.ajax({
			url: url,
			method: 'GET',
			headers: {
				'Authorization': 'Bearer ' + access_token
			},
			success: function(response){
					//the response is preformatted JSON!
					//response is album object, we want
					addRelease(response.name, response.release_date, response.label);
				}
		});
	}
	
	var listOfReleases = document.getElementById("releases-table");
	
	function addRelease(name, date, label){
		var theEnd = listOfReleases.rows.length;		
		var newRow = listOfReleases.insertRow(theEnd);
		newRow.classList.add("temp-row");
		var cell1 = newRow.insertCell(0);
		cell1.innerHTML = name;
		var cell2 = newRow.insertCell(1);
		cell2.innerHTML = date;
		var cell3 = newRow.insertCell(2);
		cell3.innerHTML = label;
	}

	/** code for the hidden login **/
	const headerWithHidden = document.getElementById("header-container");
	var hiddenEnterButton = document.getElementById("hidden-enter-button");
	
	headerWithHidden.addEventListener('mouseenter', e => {
		$(hiddenEnterButton).css('display', 'inline-block');
		$(hiddenEnterButton).fadeIn("fast");
	});
	headerWithHidden.addEventListener('mouseleave', e => {
		$(hiddenEnterButton).fadeOut("fast");
	});
	
	/** code for getting the name right in the welcome **/
	const nameToFillIn = document.getElementById("person-name");
	
	function setNameAs(name){
		nameToFillIn.innerText = name.toLowerCase();
	}
	
	
		/** Here ends Luis's code'**/

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            // render oauth info
			/**
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            }); **/

			/** here a call is made to the spotify API with the authorizer's 
			*	access token, which then returns the "me" endpoint.
			*
			**/
            $.ajax({
                url: 'https://api.spotify.com/v1/me',
                headers: {
                  'Authorization': 'Bearer ' + access_token
                },
                success: function(response) {
                  setNameAs(response.display_name);

                  $('#login').hide();
                  $('#loggedin').show();
                }
            });
          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
          }

          document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
              url: '/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            });
          }, false);
        }
      })();
    </script>
  </body>
</html>